<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catebi.Api</title>
  <link rel="stylesheet" href="/docs/css/style.css">
  <link rel="stylesheet" href="/docs/css/variables.css">
  <link rel="stylesheet" href="/docs/css/main-sidebar.css">
  <script src="/docs/js/toggle-sidebar.js" defer=""></script>
</head>
<body class="light">
  <div class="container">
    <nav class="navigation-sidebar">
      <ul class="chapters-list"><li class="chapter"><a href="/docs/">index</a></li>
<li class="chapter section"><a href="/docs/planning/">Planning</a><ul><li class="chapter"><a href="/docs/planning/database/">Database Improvements</a></li></ul></li>
<li class="chapter section"><a href="/docs/projects/">Project Docs</a><ul><li class="chapter -active"><a href="/docs/projects/catebi-api/">Catebi.Api</a></li>
<li class="chapter"><a href="/docs/projects/freeganbot/">FreeganBot</a></li>
<li class="chapter"><a href="/docs/projects/wordpress-catebige/">Wordpress.Catebige</a></li></ul></li>
<li class="chapter section"><a href="/docs/technical/">Technical Docs</a><ul><li class="chapter"><a href="/docs/technical/git/">Getting started with Git</a></li>
<li class="chapter"><a href="/docs/technical/projects/">Catebi Projects</a></li></ul></li></ul>

    </nav>
    <div class="content">
      <header class="main-header">
        <button class="toggle">Toggle Sidebar</button>
        <h1>Catebi.Api</h1>
      </header>
      <main class="main-content">
        <h1>Catebi.Api</h1>
<h2>scaffold CatebiContext</h2>
<pre><code class="language-bash">dotnet ef dbcontext scaffold &quot;Host=localhost;Port=5432;Username=catebi_admin;Password=password;Database=catebi&quot; Npgsql.EntityFrameworkCore.PostgreSQL -o Db/Entities --context-dir Db/Context -c CatebiContext --schema ctb --schema frgn --no-onconfiguring --no-pluralize --force
</code></pre>
<h2>how to run localy with docker-compose</h2>
<h3>prerequisites</h3>
<ul>
<li>install sdk .Net 8 [https://dotnet.microsoft.com/en-us/download/dotnet/8.0]</li>
<li>install vscode [https://code.visualstudio.com/download]</li>
<li>install docker desktop [https://docs.docker.com/get-docker/]</li>
<li>install pgAdmin4 [https://www.pgadmin.org/download/]</li>
<li>or install Azure Data Studio [https://learn.microsoft.com/en-us/azure-data-studio/download-azure-data-studio]</li>
<li>or any other db ide</li>
</ul>
<pre><code class="language-bash">
# 0. install sdk .Net 8
# https://dotnet.microsoft.com/en-us/download/dotnet/8.0

# 1. build api image and pull both into docker: catebi_api image and postgres image
docker-compose up -d --build

# 2. connect to postgres container via pgAdmin4 or other db ide with credentials
    - HOST=localhost
    - PORT=5432
    - USER=postgres
    - PASSWORD=password
    - POSTGRES_DB=postgres

# 3. run sql script to create db
db/schema/init_db_schema.sql

# 3.1 run first part of the script under postgres user and follow instructions
# 3.2 run second part of the script under catebi_admin user

# 4. create tables by running scripts from folder (under catebi_admin)
db/changelog/releases/1.0.0

# 5. fill tables with data by running scripts from folder (under catebi_admin)
db/changelog/releases/1.0.0/primary_filling_of_db_tables

# 6. run api in vscode with debug mode and go to url
https://localhost:7294/api/map/getcats

# 7.1 save notion api token to dotnet secrets. run in directory Catebi.Api/Catebi.Api
# auth token can be found in notion app in settings -&gt; connections -&gt; catebi.webapi -&gt; copy internal integration token
# NotionCatsDbId and NotionVolunteersDbId can be found in Cats db -&gt; copy database link -&gt; notion.so/DB_GUID?v=some_guid&amp;pvs=4 (you need DB_GUID)

# run commands in terminal in directory Catebi.Api/Catebi.Api
dotnet user-secrets set &quot;NotionApi:AuthToken&quot; &quot;AuthToken&quot;
dotnet user-secrets set &quot;NotionApi:DatabaseIds:Cats&quot; &quot;NotionCatsDbId&quot;
dotnet user-secrets set &quot;NotionApi:DatabaseIds:Volunteers&quot; &quot;NotionVolunteersDbId&quot;

# 7.2 sync data with notion by running urls in browser
https://localhost:7294/api/notionsync/syncdicts
https://localhost:7294/api/notionsync/syncvolunteers
https://localhost:7294/api/notionsync/synccats

</code></pre>
<h2>usefull commands</h2>
<pre><code class="language-bash">
# build image and push to local docker hub
docker build --pull --rm --platform linux/amd64 -f &quot;ci/docker/Dockerfile.catebi.api&quot; -t catebi_api:latest .

# build image
docker-compose up -d --build

# save image to disk
docker save catebi_api &gt; catebi_api.tar

# save image to disk to some path
docker save -o ~/Documents/../catebi_api/catebi_api.tar catebi_api

# copy image to vps
scp -i /Users/../vps/catebi_ssh_vps /Users/../catebi_api/catebi_api.tar root@VPS_IP_ADDRESS:/_catebi/api/

# connect to vps via ssh
ssh root@VPS_IP_ADDRESS -i ~/Users/../catebi_ssh_vps

# stop api container
docker stop catebi_api

# remove api container
docker rm catebi_api

# remove api image
docker rmi catebi_api

# load image from disk
docker load &lt; /_catebi/api/catebi_api.tar

# run api container with docker-compose file
docker-compose up -d
</code></pre>

      </main>
      <footer class="main-footer">
  Â© 2024 Documentation Site
  <a href="https://github.com/catebi/docs/blob/main/./src/projects/auto.11ty.js">Edit this page on GitHub</a>
</footer>

    </div>
  </div>
</body>
</html>

